# Version 2 combines scheduling and aggregating loads together
# Version 3 uses a for loop to find the cheapest time slot, instead of using the list comprehension


from time import time
from gurobipy import *

# def solve_gurobi(costs_matrix, job_demands, job_durations, num_precedences, predecessors, successors, prec_delays, percent):

show_astart = True

job_demands = [55, 15, 300, 700, 80, 2400, 3500, 1500, 400, 15]
job_durations = [3, 3, 1, 2, 3, 4, 3, 6, 3, 4]
num_precedences = 2
predecessors = [1, 7]
successors = [9, 10]
prec_delays = [62, 127]
percent = 1
costs_matrix = [
    [23306, 23305, 23304, 23303, 23302, 23301, 23300, 23299, 23298, 23297, 23296, 23295, 23294, 23293, 23292, 23291,
     23290, 23289, 23288, 23287, 23286, 23285, 23284, 23283, 23282, 23391, 23500, 23609, 23553, 23497, 23441, 23770,
     24099, 24428, 26682, 28936, 31190, 29759, 28328, 26897, 25906, 24915, 23926, 23707, 23488, 23269, 23270, 23271,
     23272, 23273, 23274, 23275, 23276, 23277, 23278, 23279, 23280, 23281, 23282, 23283, 23284, 23285, 23286, 23287,
     23288, 23289, 23290, 23291, 23292, 23293, 23294, 23295, 23296, 23297, 23298, 23299, 23355, 23411, 23467, 23413,
     23359, 23305, 23581, 23857, 24133, 24794, 25455, 26116, 28592, 31068, 33544, 39595, 45646, 51697, 98008, 144319,
     190630, 190631, 190632, 190633, 206639, 222645, 238651, 193002, 147353, 101704, 101705, 101706, 101707, 87793,
     73879, 59965, 59966, 59967, 59968, 57219, 54470, 51721, 57992, 64263, 70534, 59205, 47876, 36547, 33083, 29619,
     26155, 25606, 25057, 24508, 25059, 25610, 26161, 25337, 24513, 23689, 23635, 23581, 23527, 23638, 23749, 23860,
     99999999, 99999999],
    [6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345,
     6345, 6345, 6345, 6345, 6345, 6345, 6375, 6405, 6435, 6420, 6405, 6390, 6480, 6570, 6660, 7275, 7890, 8505, 8115,
     7725, 7335, 7065, 6795, 6525, 6465, 6405, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345,
     6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345, 6345,
     6360, 6375, 6390, 6375, 6360, 6345, 6420, 6495, 6570, 6750, 6930, 7110, 7785, 8460, 9135, 10785, 12435, 14085,
     26715, 39345, 51975, 51975, 51975, 51975, 56340, 60705, 65070, 52620, 40170, 27720, 27720, 27720, 27720, 23925,
     20130, 16335, 16335, 16335, 16335, 15585, 14835, 14085, 15795, 17505, 19215, 16125, 13035, 9945, 9000, 8055, 7110,
     6960, 6810, 6660, 6810, 6960, 7110, 6885, 6660, 6435, 6420, 6405, 6390, 6420, 6450, 6480, 99999999, 99999999],
    [43164, 43155, 43146, 43137, 43128, 43119, 43110, 43101, 43092, 43083, 43074, 43065, 43056, 43047, 43038, 43029,
     43020, 43011, 43002, 42993, 42984, 42975, 42966, 42957, 42948, 42939, 42930, 43521, 43512, 43503, 43194, 43185,
     43176, 44967, 44958, 44949, 57240, 57231, 57222, 49413, 49404, 49395, 43986, 43977, 43968, 42759, 42750, 42741,
     42732, 42723, 42714, 42705, 42696, 42687, 42678, 42669, 42660, 42651, 42642, 42633, 42624, 42615, 42606, 42597,
     42588, 42579, 42570, 42561, 42552, 42543, 42534, 42525, 42516, 42507, 42498, 42489, 42480, 42471, 42762, 42753,
     42744, 42435, 42426, 42417, 43908, 43899, 43890, 47481, 47472, 47463, 60954, 60945, 60936, 93927, 93918, 93909,
     346500, 346509, 346518, 346527, 346536, 346545, 433854, 433863, 433872, 184881, 184890, 184899, 184908, 184917,
     184926, 109035, 109044, 109053, 109062, 109071, 109080, 94089, 94098, 94107, 128316, 128325, 128334, 66543, 66552,
     66561, 47670, 47679, 47688, 44697, 44706, 44715, 47724, 47733, 47742, 43251, 43260, 43269, 42978, 42987, 42996,
     43605, 43614, 43623],
    [197630, 197628, 197626, 197624, 197622, 197620, 197618, 197616, 197614, 197612, 197610, 197608, 197606, 197604,
     197602, 197600, 197598, 197596, 197594, 197592, 197590, 197588, 197586, 197584, 197582, 197580, 198978, 200376,
     200374, 199672, 198970, 198968, 203166, 207364, 207362, 236060, 264758, 264756, 246554, 228352, 228350, 215748,
     203146, 203144, 200342, 197540, 197538, 197536, 197534, 197532, 197530, 197528, 197526, 197524, 197522, 197520,
     197518, 197516, 197514, 197512, 197510, 197508, 197506, 197504, 197502, 197500, 197498, 197496, 197494, 197492,
     197490, 197488, 197486, 197484, 197482, 197480, 197478, 198176, 198874, 198872, 198170, 197468, 197466, 200964,
     204462, 204460, 212858, 221256, 221254, 252752, 284250, 284248, 361246, 438244, 438242, 1027640, 1617038, 1617036,
     1617034, 1617032, 1617030, 1820728, 2024426, 2024424, 1443422, 862420, 862418, 862416, 862414, 862412, 685310,
     508208, 508206, 508204, 508202, 508200, 473202, 438204, 438206, 518008, 597810, 597812, 453614, 309416, 309418,
     265320, 221222, 221224, 214226, 207228, 207230, 214232, 221234, 221236, 210738, 200240, 200242, 199544, 198846,
     198848, 200250, 201652, 201654, 99999999],
    [33846, 33845, 33844, 33843, 33842, 33841, 33840, 33841, 33842, 33843, 33844, 33845, 33846, 33847, 33848, 33849,
     33850, 33851, 33852, 33853, 33854, 33855, 33856, 33857, 33858, 34019, 34180, 34341, 34262, 34183, 34104, 34585,
     35066, 35547, 38828, 42109, 45390, 43311, 41232, 39153, 37714, 36275, 34836, 34517, 34198, 33879, 33880, 33881,
     33882, 33883, 33884, 33885, 33886, 33887, 33888, 33889, 33890, 33891, 33892, 33893, 33894, 33895, 33896, 33897,
     33898, 33899, 33900, 33901, 33902, 33903, 33904, 33905, 33906, 33907, 33908, 33909, 33990, 34071, 34152, 34073,
     33994, 33915, 34316, 34717, 35118, 36079, 37040, 38001, 41602, 45203, 48804, 57605, 66406, 75207, 142568, 209929,
     277290, 277291, 277292, 277293, 300574, 323855, 347136, 280737, 214338, 147939, 147940, 147941, 147942, 127703,
     107464, 87225, 87226, 87227, 87228, 83229, 79230, 75231, 84352, 93473, 102594, 86115, 69636, 53157, 48118, 43079,
     38040, 37241, 36442, 35643, 36444, 37245, 38046, 36847, 35648, 34449, 34370, 34291, 34212, 34373, 34534, 34695,
     99999999, 99999999],
    [1354080, 1354076, 1354072, 1354068, 1354064, 1354060, 1354056, 1354052, 1354048, 1354044, 1354040, 1354036,
     1354032, 1354028, 1354024, 1354020, 1354016, 1354012, 1354008, 1354004, 1354000, 1353996, 1353992, 1353988,
     1358784, 1363580, 1368376, 1370772, 1368368, 1365964, 1377960, 1392356, 1406752, 1519548, 1617944, 1716340,
     1752336, 1689932, 1627528, 1521924, 1478720, 1435516, 1382712, 1373108, 1363504, 1353900, 1353896, 1353892,
     1353888, 1353884, 1353880, 1353876, 1353872, 1353868, 1353864, 1353860, 1353856, 1353852, 1353848, 1353844,
     1353840, 1353836, 1353832, 1353828, 1353824, 1353820, 1353816, 1353812, 1353808, 1353804, 1353800, 1353796,
     1353792, 1353788, 1353784, 1356180, 1358576, 1360972, 1360968, 1358564, 1356160, 1365756, 1377752, 1389748,
     1430544, 1459340, 1488136, 1624932, 1732928, 1840924, 2212920, 2476916, 2740912, 5025708, 7046504, 9067300,
     11088096, 11088092, 11088088, 11786484, 12484880, 13183276, 11889672, 9897668, 7905664, 5913660, 5913656, 5913652,
     5306448, 4699244, 4092040, 3484836, 3484832, 3484828, 3364824, 3244820, 3124816, 3278412, 3552008, 3825604,
     3604800, 3110404, 2616008, 1970412, 1819216, 1668020, 1492824, 1468828, 1444832, 1444836, 1468840, 1492844,
     1480848, 1444852, 1408856, 1370460, 1368064, 1365668, 1368072, 1372876, 1377680, 99999999, 99999999, 99999999],
    [1480713, 1480710, 1480707, 1480704, 1480701, 1480698, 1480695, 1480692, 1480689, 1480686, 1480683, 1480680,
     1480677, 1480674, 1480671, 1480668, 1480665, 1480662, 1480659, 1480656, 1480653, 1480650, 1480647, 1480644,
     1480641, 1487638, 1494635, 1501632, 1498129, 1494626, 1491123, 1512120, 1533117, 1554114, 1697611, 1841108,
     1984605, 1893602, 1802599, 1711596, 1648593, 1585590, 1522587, 1508584, 1494581, 1480578, 1480575, 1480572,
     1480569, 1480566, 1480563, 1480560, 1480557, 1480554, 1480551, 1480548, 1480545, 1480542, 1480539, 1480536,
     1480533, 1480530, 1480527, 1480524, 1480521, 1480518, 1480515, 1480512, 1480509, 1480506, 1480503, 1480500,
     1480503, 1480506, 1480509, 1480512, 1484015, 1487518, 1491021, 1487524, 1484027, 1480530, 1498033, 1515536,
     1533039, 1575042, 1617045, 1659048, 1816551, 1974054, 2131557, 2516560, 2901563, 3286566, 6233569, 9180572,
     12127575, 12127578, 12127581, 12127584, 13146087, 14164590, 15183093, 12278096, 9373099, 6468102, 6468105, 6468108,
     6468111, 5582614, 4697117, 3811620, 3811623, 3811626, 3811629, 3636632, 3461635, 3286638, 3685641, 4084644,
     4483647, 3762650, 3041653, 2320656, 2100159, 1879662, 1659165, 1624168, 1589171, 1554174, 1589177, 1624180,
     1659183, 1606686, 1554189, 1501692, 1498195, 1494698, 1491201, 1498204, 1505207, 1512210, 99999999, 99999999],
    [1269062, 1269060, 1269058, 1269056, 1269054, 1269052, 1269050, 1269048, 1269046, 1269044, 1269042, 1269040,
     1269038, 1269036, 1269034, 1269032, 1269030, 1269028, 1269026, 1269024, 1269022, 1269020, 1272018, 1275016,
     1278014, 1279512, 1281010, 1282508, 1290006, 1297504, 1305002, 1375500, 1446002, 1516504, 1539006, 1561508,
     1584010, 1518012, 1452014, 1386016, 1353018, 1320020, 1287022, 1281024, 1275026, 1269028, 1269030, 1269032,
     1269034, 1269036, 1269038, 1269040, 1269042, 1269044, 1269046, 1269048, 1269050, 1269052, 1269054, 1269056,
     1269058, 1269060, 1269062, 1269064, 1269066, 1269068, 1269070, 1269072, 1269074, 1269076, 1269078, 1269080,
     1269082, 1270584, 1272086, 1273588, 1273590, 1273592, 1273594, 1279596, 1285598, 1291600, 1317102, 1342604,
     1368106, 1453608, 1539110, 1624612, 1857114, 2089616, 2322118, 3750120, 5178122, 6606124, 7869126, 9132128,
     10395130, 10831632, 11268134, 11704636, 10896138, 10087640, 9279142, 8034144, 6789146, 5544148, 5164650, 4785152,
     4405654, 4026156, 3646658, 3267160, 3192162, 3117164, 3042166, 3138168, 3234170, 3330172, 3192174, 3054176,
     2916178, 2512680, 2109182, 1705684, 1596186, 1486688, 1377190, 1377192, 1377194, 1377196, 1369698, 1362200,
     1354702, 1330704, 1306706, 1282708, 1284210, 1285712, 1287214, 99999999, 99999999, 99999999, 99999999, 99999999],
    [169273, 169272, 169271, 169270, 169269, 169268, 169267, 169266, 169265, 169264, 169263, 169262, 169261, 169260,
     169259, 169258, 169257, 169256, 169255, 169254, 169253, 169252, 169251, 169250, 169249, 170048, 170847, 171646,
     171245, 170844, 170443, 172842, 175241, 177640, 194039, 210438, 226837, 216436, 206035, 195634, 188433, 181232,
     174031, 172430, 170829, 169228, 169227, 169226, 169225, 169224, 169223, 169222, 169221, 169220, 169219, 169218,
     169217, 169216, 169215, 169214, 169213, 169212, 169211, 169210, 169209, 169208, 169207, 169206, 169205, 169204,
     169203, 169202, 169201, 169200, 169201, 169202, 169603, 170004, 170405, 170006, 169607, 169208, 171209, 173210,
     175211, 180012, 184813, 189614, 207615, 225616, 243617, 287618, 331619, 375620, 712421, 1049222, 1386023, 1386024,
     1386025, 1386026, 1502427, 1618828, 1735229, 1403230, 1071231, 739232, 739233, 739234, 739235, 638036, 536837,
     435638, 435639, 435640, 435641, 415642, 395643, 375644, 421245, 466846, 512447, 430048, 347649, 265250, 240051,
     214852, 189653, 185654, 181655, 177656, 181657, 185658, 189659, 183660, 177661, 171662, 171263, 170864, 170465,
     171266, 172067, 172868, 99999999, 99999999],
    [8782, 8775, 8768, 8761, 8754, 8747, 8740, 8733, 8726, 8719, 8712, 8705, 8698, 8691, 8684, 8677, 8670, 8663, 8656,
     8649, 8642, 8635, 8628, 8621, 8644, 8667, 8690, 8698, 8676, 8654, 8722, 8805, 8888, 9586, 10194, 10802, 11020,
     10623, 10226, 9559, 9282, 9005, 8668, 8601, 8534, 8467, 8460, 8467, 8474, 8481, 8488, 8495, 8502, 8509, 8516, 8523,
     8530, 8537, 8544, 8551, 8558, 8565, 8572, 8579, 8586, 8593, 8600, 8607, 8614, 8621, 8628, 8635, 8642, 8649, 8656,
     8678, 8700, 8722, 8729, 8721, 8713, 8780, 8862, 8944, 9206, 9393, 9580, 10442, 11124, 11806, 14138, 15795, 17452,
     31739, 44376, 57013, 69650, 69657, 69664, 74036, 78408, 82780, 74702, 62259, 49816, 37373, 37380, 37387, 33599,
     29811, 26023, 22235, 22242, 22249, 21506, 20763, 20020, 20987, 22704, 24421, 23048, 19965, 16882, 12854, 11916,
     10978, 9890, 9747, 9604, 9611, 9768, 9925, 9857, 9639, 9421, 9188, 9180, 9172, 9194, 9231, 9268, 99999999,
     99999999, 99999999]]
# no_intervals_day = len(costs_matrix[0])
INTERVALS_DAY = range(len(costs_matrix[0]))

start = time()
m = Model("household_load_scheduling")

devices = []
DEVICES = range(len(costs_matrix))
PREC = range(num_precedences)
max_demand = int(sum(job_demands) * percent)

for i in DEVICES:
    d_times = []
    for _ in range(len(costs_matrix[i])):
        d_t = m.addVar(vtype=GRB.BINARY)
        d_times.append(d_t)
    devices.append(d_times)
    m.addConstr(sum(d_times) == 1)

# for _ in DEVICES:
#     d_t = m.addVar(INTERVALS, vtype=GRB.INTEGER)

for t in INTERVALS_DAY:
    interval_demand = sum([devices[i][t] * job_demands[i] for i in DEVICES])
    m.addConstr(interval_demand <= max_demand)
#
for p in PREC:
    pre = predecessors[p] - 1
    succ = successors[p] - 1
    d = prec_delays[p]

    astart_pre = sum([devices[pre][t] * t for t in INTERVALS_DAY])
    astart_succ = sum([devices[succ][t] * t for t in INTERVALS_DAY])

    # m.addConstr(astart_pre + job_durations[pre]
    #             <= astart_succ
    #             <= astart_pre + job_durations[pre] + d)

    m.addConstr(astart_pre + job_durations[pre] <= astart_succ)
    m.addConstr(astart_succ <= astart_pre + job_durations[pre] + d)


m.setObjective(sum([sum([devices[i][t] * costs_matrix[i][t] for t in INTERVALS_DAY])
                    for i in DEVICES]), GRB.MINIMIZE)

m.setParam('OutputFlag', True)
m.optimize()

# print("g solve time", time() - start)
#
# print('\nTOTAL COSTS: %g' % m.objVal)
# print('SOLUTION:')

astarts = [sum([int(i * t.x) for i, t in enumerate(d)]) + 1
           for d in devices]

if show_astart:
    print("g solution", astarts, m.objVal)